<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>গার্মেন্টস স্যালারি ও ওটি ক্যালকুলেটর</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Compat version for HTML) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.1);
            --card-border: rgba(255, 255, 255, 0.2);
            --text-color: #ffffff;
            --text-muted: #d1d5db;
            --accent-color: #fbbf24;
            --bg-color: #1e1e2f;
            --nav-bg: rgba(30, 30, 47, 0.95);
            --success: #10b981;
            --danger: #ef4444;
            --radius: 16px;
        }

        /* Light Mode Improved */
        body.light-mode {
            --bg-color: #f0f2f5;
            --text-color: #1f2937;
            --text-muted: #4b5563;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --nav-bg: #ffffff;
            --primary-gradient: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }
        
        body.light-mode .glass-panel {
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e1e4e8;
            color: #333;
        }

        body.light-mode input, body.light-mode select {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            color: #111;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Noto Sans Bengali', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            background-image: var(--primary-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 90px;
            transition: background 0.3s ease;
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .items-center { align-items: center; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        
        /* Glassmorphism Cards */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transition: all 0.3s ease;
        }

        /* Inputs & Buttons */
        input, select {
            width: 100%; padding: 12px; margin-bottom: 10px;
            border-radius: 10px; border: 1px solid var(--card-border);
            background: rgba(255, 255, 255, 0.9); color: #333;
            font-size: 1rem; outline: none;
        }
        
        button {
            width: 100%; padding: 12px; border-radius: 10px; border: none;
            background: linear-gradient(90deg, #ff8a00, #e52e71);
            color: white; font-weight: 600; font-size: 1rem; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.96); }
        .btn-secondary { background: rgba(255,255,255,0.2); border: 1px solid white; }
        body.light-mode .btn-secondary { background: #e5e7eb; border: 1px solid #ccc; color: #333; }
        .btn-danger { background: var(--danger); color: white !important; }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page { animation: fadeIn 0.4s ease-out; display: none; padding: 15px; }
        .page.active { display: block; }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--nav-bg); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; padding: 12px 0;
            border-top: 1px solid var(--card-border); z-index: 1000;
        }
        .nav-item { background: none; border: none; color: var(--text-muted); font-size: 0.8rem; box-shadow: none; }
        .nav-item i { font-size: 1.3rem; display: block; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent-color); }
        body.light-mode .nav-item.active { color: #e52e71; }

        /* Summary Grid */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { text-align: center; padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .bg-purple { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .bg-blue { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .bg-orange { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        .bg-pink { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); }
        .big-text { font-size: 1.4rem; font-weight: bold; margin-top: 5px; }
        
        /* Table */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th, .data-table td { padding: 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem; }
        body.light-mode .data-table th, body.light-mode .data-table td { border-bottom: 1px solid #ddd; }
        
        /* Ad Containers */
        .ad-container { margin: 15px auto; text-align: center; overflow: hidden; display: flex; justify-content: center; align-items: center; border-radius: 8px; background: rgba(0,0,0,0.02); }

        /* Auth & Modal */
        #auth-screen, .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; padding: 20px;
        }
        #auth-screen { background: var(--primary-gradient); overflow-y: auto; }
        .modal { background: rgba(0,0,0,0.85); z-index: 3000; display: none; }
        .modal.active { display: flex; }
        .app-logo { width: 80px; height: 80px; background: white; border-radius: 50%; padding: 5px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* Click overlay for Ads */
        #ad-click-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; }
    </style>
</head>
<body>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <img src="https://i.postimg.cc/kGZ8J76f/logo.png" class="app-logo" alt="Logo">
        <h2 style="color:white; margin-bottom: 20px; text-align:center;">গার্মেন্টস স্যালারি অ্যাপ</h2>
        
        <!-- Login Form -->
        <div id="login-form" class="glass-panel w-full" style="max-width: 350px;">
            <h3 class="mb-4 text-center">লগইন করুন</h3>
            <input type="tel" id="login-phone" placeholder="মোবাইল নম্বর (11 digit)">
            <input type="password" id="login-pin" placeholder="PIN (পাসওয়ার্ড)" maxlength="6">
            <button onclick="handleLogin()">লগইন</button>
            <p class="mt-4 text-center text-sm" style="color:white">অ্যাকাউন্ট নেই? <a href="#" onclick="toggleAuth('signup')" style="color:var(--accent-color); font-weight:bold;">সাইন আপ করুন</a></p>
        </div>

        <!-- Signup Form -->
        <div id="signup-form" class="glass-panel w-full hidden" style="max-width: 350px;">
            <h3 class="mb-4 text-center">নতুন অ্যাকাউন্ট খুলুন</h3>
            <input type="text" id="reg-name" placeholder="আপনার নাম">
            <input type="tel" id="reg-phone" placeholder="মোবাইল নম্বর">
            <select id="reg-designation" onchange="checkOtherDesignation()">
                <option value="">পদবী নির্বাচন করুন</option>
                <option value="Operator">Operator</option><option value="Helper">Helper</option><option value="Iron Man">Iron Man</option><option value="Quality">Quality</option><option value="PM">PM</option><option value="GM">GM</option><option value="Line Chief">Line Chief</option><option value="Supervisor">Supervisor</option><option value="Time keeper">Time keeper</option><option value="Other">অন্যান্য (Other)</option>
            </select>
            <input type="text" id="reg-other-designation" placeholder="পদবী লিখুন" class="hidden">
            <div class="flex" style="gap: 5px;"><input type="text" id="reg-grade" placeholder="গ্রেড"><input type="number" id="reg-basic" placeholder="বেসিক বেতন"></div>
            <input type="number" id="reg-gross" placeholder="মোট বেতন (Gross)">
            <input type="password" id="reg-pin" placeholder="PIN দিন (পাসওয়ার্ড হিসেবে)" maxlength="6">
            <button onclick="handleSignup()">সাইন আপ</button>
            <p class="mt-4 text-center text-sm" style="color:white">আগেই অ্যাকাউন্ট আছে? <a href="#" onclick="toggleAuth('login')" style="color:var(--accent-color); font-weight:bold;">লগইন</a></p>
        </div>
    </div>

    <!-- Bonus Setup Modal (Runs after signup) -->
    <div id="bonus-setup-modal" class="modal">
        <div class="glass-panel w-full" style="max-width: 350px; background: var(--bg-color);">
            <h3 class="text-center mb-4">হাজিরা বোনাস সেটআপ</h3>
            <p class="text-sm text-muted mb-4 text-center">আপনার ফ্যাক্টরিতে হাজিরা বোনাস কত টাকা?</p>
            <input type="number" id="setup-bonus-amount" placeholder="যেমন: 725 বা 500">
            <button onclick="saveBonusSetting()">সেভ করুন</button>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="hidden">
        
        <!-- HOME PAGE -->
        <div id="home" class="page active">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 id="home-greeting">স্বাগতম!</h2>
                    <p class="text-sm" id="current-date-display" style="opacity:0.8"></p>
                </div>
                <img src="https://i.postimg.cc/kGZ8J76f/logo.png" style="width: 40px; border-radius:50%">
            </div>

            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="stat-card bg-purple">
                    <p>মোট ওভারটাইম</p>
                    <div class="big-text"><span id="total-ot-hours">0</span> ঘ</div>
                </div>
                <div class="stat-card bg-blue">
                    <p>আনুমানিক বেতন</p>
                    <div class="big-text"><span id="est-salary">0</span> ৳</div>
                </div>
                <div class="stat-card bg-orange">
                    <p>হাজিরা বোনাস</p>
                    <div class="big-text"><span id="display-bonus">0</span> ৳</div>
                </div>
                <div class="stat-card bg-pink">
                    <p>অন্যান্য সুবিধা</p>
                    <div class="big-text"><span id="other-bills">0</span> ৳</div>
                </div>
            </div>

            <!-- Holidays -->
            <div class="glass-panel mt-4">
                <div class="flex justify-between items-center mb-2">
                    <h3><i class="fas fa-calendar-alt" style="color: var(--accent-color)"></i> সরকারি ছুটি</h3>
                    <span class="text-sm" style="background:var(--accent-color); padding:2px 8px; border-radius:10px; color:#000;">বর্তমান মাস</span>
                </div>
                <div id="holiday-list" style="min-height: 50px;">
                    <!-- JS will populate current month holidays -->
                </div>
            </div>

            <!-- AD: Home Bottom (300x250) -->
            <div class="ad-container" style="width: 300px; height: 250px;">
                <script type="text/javascript">
                    atOptions = {
                        'key' : 'f05e53994372c08a40f69021b94c737b',
                        'format' : 'iframe',
                        'height' : 250,
                        'width' : 300,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="//www.highperformanceformat.com/f05e53994372c08a40f69021b94c737b/invoke.js"></script>
            </div>
        </div>

        <!-- OVERTIME PAGE -->
        <div id="overtime" class="page">
            <h2 class="mb-4">ওভারটাইম যোগ করুন</h2>
            
            <!-- AD: Overtime Top (468x60) -->
            <div class="ad-container" style="width: 468px; height: 60px; max-width: 100%;">
                 <script type="text/javascript">
                    atOptions = {
                        'key' : 'cbfb25dda043c3217cef8dea9f896df2',
                        'format' : 'iframe',
                        'height' : 60,
                        'width' : 468,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="//www.highperformanceformat.com/cbfb25dda043c3217cef8dea9f896df2/invoke.js"></script>
            </div>

            <div class="glass-panel mt-4">
                <label>তারিখ নির্বাচন করুন</label>
                <input type="date" id="ot-date">
                
                <label>কাজের ধরণ</label>
                <select id="ot-type" onchange="toggleOtHoursInput()">
                    <option value="General">General Day</option>
                    <option value="Night">Night</option>
                    <option value="Friday">Friday/Holiday</option>
                    <option value="Absent">অনুপস্থিত (Absent)</option>
                </select>

                <div id="ot-hours-container">
                    <label>ওভারটাইম (ঘন্টা)</label>
                    <input type="number" id="ot-hours" placeholder="যেমন: ২ অথবা ৪">
                </div>

                <button onclick="addOvertime()" class="mt-2"><i class="fas fa-plus-circle"></i> সেভ করুন</button>
            </div>

            <div class="glass-panel mt-4">
                <h3><i class="fas fa-utensils"></i> টিফিন / নাইট বিল</h3>
                <select id="bill-type">
                    <option value="Tiffin">টিফিন বিল</option>
                    <option value="NightBill">নাইট বিল</option>
                    <option value="Other">অন্যান্য</option>
                </select>
                <input type="number" id="bill-amount" placeholder="টাকার পরিমাণ">
                <button onclick="addBill()" class="btn-secondary mt-2">বিল যোগ করুন</button>
            </div>
        </div>

        <!-- CALCULATOR PAGE -->
        <div id="calculator" class="page">
            <h2 class="mb-4">বেতন ক্যালকুলেটর</h2>
            
            <div class="glass-panel">
                <div class="flex justify-between mb-2"><span>মূল বেতন (Gross):</span><span id="calc-gross">0</span></div>
                <div class="flex justify-between mb-2"><span>বেসিক (Basic):</span><span id="calc-basic">0</span></div>
                <div class="flex justify-between mb-4"><span>মোট OT ঘন্টা:</span><span id="calc-total-ot">0</span></div>
                
                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.3); margin: 10px 0;">
                
                <div class="flex items-center mb-4">
                    <input type="checkbox" id="check-att-bonus" style="width: 20px; height: 20px; margin: 0 10px 0 0;" checked>
                    <label for="check-att-bonus">হাজিরা বোনাস (<span id="calc-bonus-amt">0</span> টাকা) যোগ হবে?</label>
                </div>

                <button onclick="calculateSalaryDetails()">হিসাব করুন</button>
            </div>

            <div id="calc-result" class="glass-panel hidden mt-4" style="background: rgba(16, 185, 129, 0.1);">
                <h3 class="text-center mb-2" style="color: var(--success)">হিসাবের বিবরণ</h3>
                <table class="w-full text-sm">
                    <tr><td>বেসিক সেলারি:</td><td class="text-right" id="res-basic">0</td></tr>
                    <tr><td>বাড়ি ভাড়া (৫০%):</td><td class="text-right" id="res-house">0</td></tr>
                    <tr><td>চিকিৎসা ভাতা (১০%):</td><td class="text-right" id="res-med">0</td></tr>
                    <tr><td>OT রেট (প্রতি ঘন্টা):</td><td class="text-right" id="res-ot-rate">0</td></tr>
                    <tr><td>মোট OT টাকা:</td><td class="text-right" id="res-ot-total">0</td></tr>
                    <tr><td>হাজিরা বোনাস:</td><td class="text-right" id="res-bonus">0</td></tr>
                    <tr><td>বিল/অন্যান্য:</td><td class="text-right" id="res-bills">0</td></tr>
                    <tr style="font-weight: bold; border-top: 1px solid white;">
                        <td class="pt-2">সর্বমোট বেতন:</td>
                        <td class="pt-2 text-right" id="res-grand-total">0</td>
                    </tr>
                </table>
            </div>

            <!-- AD: Calculator Bottom (320x50) -->
            <div class="ad-container" style="width: 320px; height: 50px;">
                <script type="text/javascript">
                    atOptions = {
                        'key' : 'c9a0024b83c53997d0f0f8b4f10653c9',
                        'format' : 'iframe',
                        'height' : 50,
                        'width' : 320,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="//www.highperformanceformat.com/c9a0024b83c53997d0f0f8b4f10653c9/invoke.js"></script>
            </div>
        </div>

        <!-- LIST PAGE -->
        <div id="list" class="page">
            <h2 class="mb-4">কাজের তালিকা</h2>
            
            <!-- AD: List Page Top (728x90) -->
            <div class="ad-container" style="width: 728px; height: 90px; max-width: 100%;">
                <script type="text/javascript">
                    atOptions = {
                        'key' : '82181d21b05884891d9488e2b7fb793b',
                        'format' : 'iframe',
                        'height' : 90,
                        'width' : 728,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="//www.highperformanceformat.com/82181d21b05884891d9488e2b7fb793b/invoke.js"></script>
            </div>

            <div class="glass-panel" style="padding: 0;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>তারিখ</th>
                            <th>ধরণ</th>
                            <th>পরিমাণ</th>
                            <th>একশন</th>
                        </tr>
                    </thead>
                    <tbody id="work-history-body">
                        <!-- Data rows -->
                    </tbody>
                </table>
                <div id="empty-msg" class="p-4 text-center text-muted hidden">কোন তথ্য পাওয়া যায়নি</div>
            </div>
        </div>

        <!-- PROFILE PAGE -->
        <div id="profile" class="page">
            <div class="glass-panel text-center">
                <div class="app-logo" style="margin: 0 auto 10px; display:flex; justify-content:center; align-items:center; font-size: 2rem; color: #333; font-weight:bold;">
                    <span id="avatar-initial">U</span>
                </div>
                <h3 id="profile-name">User Name</h3>
                <p id="profile-desig" class="text-sm" style="color: var(--accent-color)">Designation</p>
                <p id="profile-phone" class="text-sm text-muted">01xxxxxxxxx</p>
                <div class="mt-2 text-sm">গ্রেড: <span id="profile-grade">N/A</span> | বেতন: <span id="profile-gross">0</span></div>
            </div>

            <div class="glass-panel mt-4">
                <button onclick="openModal('edit-profile-modal')" class="btn-secondary mb-2"><i class="fas fa-user-edit"></i> তথ্য পরিবর্তন</button>
                <button onclick="toggleDarkMode()" class="btn-secondary mb-2"><i class="fas fa-moon"></i> লাইট/ডার্ক মোড</button>
                <button onclick="openModal('privacy-modal')" class="btn-secondary mb-2">গোপনীয়তা নীতি</button>
                <button onclick="logout()" class="btn-danger"><i class="fas fa-sign-out-alt"></i> লগআউট</button>
            </div>
            
            <p class="text-center text-sm text-muted mt-4">Version 2.0.0</p>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav hidden" id="main-nav">
        <button class="nav-item active" onclick="navTo('home')"><i class="fas fa-home"></i> হোম</button>
        <button class="nav-item" onclick="navTo('overtime')"><i class="fas fa-clock"></i> ওটি</button>
        <button class="nav-item" onclick="navTo('calculator')"><i class="fas fa-calculator"></i> হিসাব</button>
        <button class="nav-item" onclick="navTo('list')"><i class="fas fa-list"></i> তালিকা</button>
        <button class="nav-item" onclick="navTo('profile')"><i class="fas fa-user"></i> প্রোফাইল</button>
    </nav>

    <!-- EDIT PROFILE MODAL -->
    <div id="edit-profile-modal" class="modal">
        <div class="glass-panel w-full" style="max-width: 400px; background: var(--bg-color);">
            <h3>তথ্য পরিবর্তন</h3>
            <p class="text-sm text-muted mb-4">একবার পরিবর্তন করলে ৭ দিন লক থাকবে।</p>
            <input type="text" id="edit-name" placeholder="নাম">
            <input type="text" id="edit-desig" placeholder="পদবী">
            <input type="text" id="edit-grade" placeholder="গ্রেড">
            <input type="number" id="edit-gross" placeholder="নতুন মোট বেতন">
            <button onclick="saveProfileEdit()">সেভ করুন</button>
            <button onclick="closeModal('edit-profile-modal')" class="btn-secondary mt-2">বাতিল</button>
        </div>
    </div>

    <!-- PRIVACY MODAL -->
    <div id="privacy-modal" class="modal">
        <div class="glass-panel w-full" style="max-width: 400px; background: var(--bg-color);">
            <h3>গোপনীয়তা নীতি</h3>
            <div style="height:250px; overflow-y:auto; font-size:0.9rem; margin-bottom:10px;">
                <p>১. আপনার ডাটা সুরক্ষিত Firebase সার্ভারে জমা থাকে।</p>
                <p>২. আমরা বিজ্ঞাপন প্রদর্শনের জন্য থার্ড-পার্টি সার্ভিস ব্যবহার করি।</p>
            </div>
            <button onclick="closeModal('privacy-modal')">বন্ধ করুন</button>
        </div>
    </div>

    <!-- Social Bar Script Container -->
    <div id="social-bar-container"></div>

    <script>
        // --- CONFIGURATION ---
        // TODO: Replace with your Real Firebase Config
        const firebaseConfig = {
  apiKey: "AIzaSyCOets_8BQkDex92Qrb21uhzrAVRXnPXms",
  authDomain: "overtime-calculator-8c926.firebaseapp.com",
  databaseURL: "https://overtime-calculator-8c926-default-rtdb.firebaseio.com",
  projectId: "overtime-calculator-8c926",
  storageBucket: "overtime-calculator-8c926.firebasestorage.app",
  messagingSenderId: "1044899871918",
  appId: "1:1044899871918:web:5493af45b9927bafaac13f"
};

        // Initialize Firebase
        let db, auth;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            auth = firebase.auth();
            console.log("Firebase Connected");
        } catch (e) {
            console.error("Firebase Config Missing", e);
        }

        let currentUser = null;
        let currentData = { ot: [], bills: [] };

        // Holiday List (Full Dates)
        const allHolidays = [
            "2025-01-26", "2025-02-21", "2025-03-17", "2025-03-26", 
            "2025-04-14", "2025-05-01", "2025-05-12", "2025-06-07",
            "2025-07-17", "2025-08-15", "2025-09-05", "2025-10-02",
            "2025-12-16", "2025-12-25"
        ];

        // --- AUTHENTICATION ---
        
        // Listen to Auth State Changes
        if(auth) {
            auth.onAuthStateChanged(user => {
                if (user) {
                    loadUserData(user.uid);
                } else {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('app-content').classList.add('hidden');
                    document.getElementById('main-nav').classList.add('hidden');
                }
            });
        }

        function toggleAuth(mode) {
            if (mode === 'signup') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
            } else {
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            }
        }

        function checkOtherDesignation() {
            const val = document.getElementById('reg-designation').value;
            document.getElementById('reg-other-designation').classList.toggle('hidden', val !== 'Other');
        }

        // SIGN UP using Firebase Auth
        function handleSignup() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            let desig = document.getElementById('reg-designation').value;
            if (desig === 'Other') desig = document.getElementById('reg-other-designation').value;
            const basic = parseFloat(document.getElementById('reg-basic').value);
            const gross = parseFloat(document.getElementById('reg-gross').value);
            const grade = document.getElementById('reg-grade').value;
            const pin = document.getElementById('reg-pin').value;

            if (!name || !phone || !desig || !basic || !gross || pin.length < 6) {
                alert("সব তথ্য দিন। PIN কমপক্ষে ৬ সংখ্যার হতে হবে।");
                return;
            }

            const email = phone + "@gmcalculator.com"; // Fake email for phone auth

            auth.createUserWithEmailAndPassword(email, pin)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    
                    const userData = {
                        uid: user.uid,
                        phone: phone,
                        name: name,
                        designation: desig,
                        grade: grade,
                        basic: basic,
                        gross: gross,
                        attendanceBonus: 0, // Will set next
                        joined: new Date().toISOString()
                    };

                    // Save to DB
                    db.ref('users/' + user.uid).set(userData).then(() => {
                        currentUser = userData;
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('bonus-setup-modal').classList.add('active'); // Show Bonus Setup
                    });
                })
                .catch((error) => {
                    alert("Error: " + error.message);
                });
        }

        // LOGIN
        function handleLogin() {
            const phone = document.getElementById('login-phone').value;
            const pin = document.getElementById('login-pin').value;
            const email = phone + "@gmcalculator.com";

            auth.signInWithEmailAndPassword(email, pin)
                .catch((error) => {
                    alert("লগইন ব্যর্থ। মোবাইল নম্বর বা পিন চেক করুন।");
                });
        }

        function logout() {
            auth.signOut();
            location.reload();
        }

        // --- BONUS SETUP ---
        function saveBonusSetting() {
            const bonus = parseFloat(document.getElementById('setup-bonus-amount').value);
            if(isNaN(bonus)) { alert("টাকার পরিমাণ দিন"); return; }
            
            if(currentUser && db) {
                db.ref('users/' + currentUser.uid).update({ attendanceBonus: bonus });
                currentUser.attendanceBonus = bonus;
                closeModal('bonus-setup-modal');
                showApp();
            }
        }

        // --- MAIN APP LOGIC ---

        function loadUserData(uid) {
            db.ref('users/' + uid).once('value').then((snapshot) => {
                currentUser = snapshot.val();
                if(!currentUser) return; // Should not happen if auth exists

                // If bonus is 0 or missing, show setup modal, else show app
                if(!currentUser.attendanceBonus || currentUser.attendanceBonus === 0) {
                     document.getElementById('auth-screen').classList.add('hidden');
                     document.getElementById('bonus-setup-modal').classList.add('active');
                } else {
                    showApp();
                }
            });
        }

        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('bonus-setup-modal').classList.remove('active');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('main-nav').classList.remove('hidden');
            
            // Set Date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('bn-BD', options);
            
            // UI Update
            fillProfileUI();
            loadHistoryData();
            renderCurrentMonthHolidays();
            navTo('home');
        }

        function fillProfileUI() {
            document.getElementById('home-greeting').innerText = `হাই, ${currentUser.name}`;
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-desig').innerText = currentUser.designation;
            document.getElementById('profile-phone').innerText = currentUser.phone;
            document.getElementById('profile-grade').innerText = currentUser.grade;
            document.getElementById('profile-gross').innerText = currentUser.gross;
            document.getElementById('avatar-initial').innerText = currentUser.name.charAt(0).toUpperCase();

            // Populate Calculator
            document.getElementById('calc-gross').innerText = currentUser.gross;
            document.getElementById('calc-basic').innerText = currentUser.basic;
            document.getElementById('calc-bonus-amt').innerText = currentUser.attendanceBonus;
            document.getElementById('display-bonus').innerText = currentUser.attendanceBonus;
            
            // Populate Edit Form
            document.getElementById('edit-name').value = currentUser.name;
            document.getElementById('edit-desig').value = currentUser.designation;
            document.getElementById('edit-grade').value = currentUser.grade;
            document.getElementById('edit-gross').value = currentUser.gross;
        }

        function loadHistoryData() {
            db.ref('data/' + currentUser.uid).on('value', (snapshot) => {
                const val = snapshot.val();
                if(val) {
                    currentData = val;
                    if(!currentData.ot) currentData.ot = [];
                    if(!currentData.bills) currentData.bills = [];
                } else {
                    currentData = { ot: [], bills: [] };
                }
                updateUI();
            });
        }

        function updateUI() {
            // 1. OT Total
            let totalOT = 0;
            if(currentData.ot) currentData.ot.forEach(x => totalOT += (x.hours || 0));
            document.getElementById('total-ot-hours').innerText = totalOT;

            // 2. Bills Total
            let totalBills = 0;
            if(currentData.bills) currentData.bills.forEach(x => totalBills += (x.amount || 0));
            document.getElementById('other-bills').innerText = totalBills;

            // 3. Estimated Salary
            const otRate = (currentUser.basic / 208) * 2; // Standard 208 hours or 26 days * 8
            const otAmount = Math.round(totalOT * otRate);
            // Estimated = Gross + OT + Bonus + Bills
            const estTotal = Math.round(currentUser.gross + otAmount + currentUser.attendanceBonus + totalBills); 
            document.getElementById('est-salary').innerText = estTotal;
            
            // Update Calculator View
            document.getElementById('calc-total-ot').innerText = totalOT;

            // 4. List Table
            const tbody = document.getElementById('work-history-body');
            tbody.innerHTML = '';
            const allEntries = [...(currentData.ot||[]), ...(currentData.bills||[])];
            allEntries.sort((a,b) => b.id - a.id);

            if(allEntries.length === 0) {
                document.getElementById('empty-msg').classList.remove('hidden');
            } else {
                document.getElementById('empty-msg').classList.add('hidden');
                allEntries.forEach(item => {
                    const row = document.createElement('tr');
                    const val = item.category === 'OT' ? item.hours + ' ঘ' : item.amount + ' ৳';
                    const typeLabel = item.type === 'General' ? 'জেনারেল' : 
                                      item.type === 'Night' ? 'নাইট' : 
                                      item.type === 'Friday' ? 'ছুটি' : item.type;
                    
                    row.innerHTML = `
                        <td>${item.date}</td>
                        <td>${typeLabel}</td>
                        <td>${val}</td>
                        <td><button onclick="deleteEntry(${item.id}, '${item.category}')" class="btn-danger" style="padding:4px 8px;"><i class="fas fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // --- HOLIDAYS ---
        function renderCurrentMonthHolidays() {
            const list = document.getElementById('holiday-list');
            list.innerHTML = '';
            
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-11
            
            const monthHolidays = allHolidays.filter(h => {
                const hDate = new Date(h);
                return hDate.getMonth() === currentMonth;
            });

            if (monthHolidays.length === 0) {
                list.innerHTML = '<p class="text-sm text-center p-2 text-muted">এই মাসে কোনো সরকারি ছুটি নেই।</p>';
                return;
            }

            monthHolidays.forEach(h => {
                const d = new Date(h);
                const dateStr = d.toLocaleDateString('bn-BD', {day: 'numeric', month: 'long'});
                const div = document.createElement('div');
                div.style.cssText = "padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between;";
                div.innerHTML = `<span>${dateStr}</span><span style="color:var(--accent-color)">সরকারি ছুটি</span>`;
                list.appendChild(div);
            });
        }

        // --- ACTIONS ---
        function addOvertime() {
            const date = document.getElementById('ot-date').value;
            const type = document.getElementById('ot-type').value;
            let hours = parseFloat(document.getElementById('ot-hours').value);

            if (!date) { alert("তারিখ দিন"); return; }
            if (type !== 'Absent' && isNaN(hours)) { alert("ঘন্টা লিখুন"); return; }
            if (type === 'Absent') hours = 0;

            const entry = { id: Date.now(), date, type, hours, category: 'OT' };
            currentData.ot.push(entry);
            syncData();
            alert("ওভারটাইম যুক্ত হয়েছে!");
        }

        function addBill() {
            const type = document.getElementById('bill-type').value;
            const amount = parseFloat(document.getElementById('bill-amount').value);
            if (isNaN(amount)) { alert("টাকার পরিমাণ দিন"); return; }

            const entry = { id: Date.now(), date: new Date().toISOString().split('T')[0], type, amount, category: 'Bill' };
            currentData.bills.push(entry);
            syncData();
            alert("বিল যুক্ত হয়েছে!");
        }

        function deleteEntry(id, category) {
            if(confirm("মুছে ফেলতে চান?")) {
                if(category === 'OT') currentData.ot = currentData.ot.filter(x => x.id !== id);
                else currentData.bills = currentData.bills.filter(x => x.id !== id);
                syncData();
            }
        }

        function syncData() {
            if(currentUser && db) {
                db.ref('data/' + currentUser.uid).set(currentData);
            }
        }

        function calculateSalaryDetails() {
            const basic = currentUser.basic;
            const gross = currentUser.gross;
            
            // Calc
            const totalOT = parseFloat(document.getElementById('calc-total-ot').innerText);
            const otRate = (basic / 208) * 2;
            const otAmount = Math.round(totalOT * otRate);
            
            let bonus = 0;
            if (document.getElementById('check-att-bonus').checked) {
                bonus = currentUser.attendanceBonus;
            }

            const bills = parseFloat(document.getElementById('other-bills').innerText);
            const grandTotal = Math.round(gross + otAmount + bonus + bills);

            // Display
            document.getElementById('res-basic').innerText = basic;
            document.getElementById('res-house').innerText = Math.round(basic * 0.50); // Approx house rent breakdown
            document.getElementById('res-med').innerText = Math.round(basic * 0.10);
            document.getElementById('res-ot-rate').innerText = otRate.toFixed(2);
            document.getElementById('res-ot-total').innerText = otAmount;
            document.getElementById('res-bonus').innerText = bonus;
            document.getElementById('res-bills').innerText = bills;
            document.getElementById('res-grand-total').innerText = grandTotal;

            document.getElementById('calc-result').classList.remove('hidden');
            document.getElementById('calc-result').scrollIntoView({behavior: 'smooth'});
        }

        // --- PROFILE EDIT ---
        function saveProfileEdit() {
            const now = Date.now();
            const lastEdit = currentUser.lastProfileEdit || 0;
            const diffDays = (now - lastEdit) / (1000 * 3600 * 24);

            if (diffDays < 7) {
                alert(`তথ্য পরিবর্তন করা যাবে না। আরো ${Math.ceil(7 - diffDays)} দিন অপেক্ষা করুন।`);
                return;
            }

            const updates = {
                name: document.getElementById('edit-name').value,
                designation: document.getElementById('edit-desig').value,
                grade: document.getElementById('edit-grade').value,
                gross: parseFloat(document.getElementById('edit-gross').value),
                lastProfileEdit: now
            };

            db.ref('users/' + currentUser.uid).update(updates).then(() => {
                alert("তথ্য আপডেট হয়েছে!");
                currentUser = {...currentUser, ...updates};
                fillProfileUI();
                closeModal('edit-profile-modal');
            });
        }

        // --- HELPERS ---
        function toggleOtHoursInput() {
            const type = document.getElementById('ot-type').value;
            document.getElementById('ot-hours-container').style.display = (type === 'Absent') ? 'none' : 'block';
        }

        function navTo(pageId) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const index = ['home', 'overtime', 'calculator', 'list', 'profile'].indexOf(pageId);
            if(index >= 0) document.querySelectorAll('.nav-item')[index].classList.add('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function toggleDarkMode() { document.body.classList.toggle('light-mode'); }

        // --- SOCIAL BAR AD LOGIC (Trigger on Click) ---
        function triggerSocialBar() {
            // Remove existing script if any to re-trigger
            const container = document.getElementById('social-bar-container');
            container.innerHTML = '';
            
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = '//pl21010220.effectivegatecpm.com/36/f2/6e/36f26ed6744e876235db846fba07df11.js';
            
            container.appendChild(script);
            console.log("Social Bar Ad Triggered");
        }

        // Add Global Click Listener for Ads
        document.addEventListener('click', function(e) {
            // Check if it's a button or interactive element to avoid spamming on empty space clicks if preferred,
            // or just trigger on any click as requested:
            triggerSocialBar();
        });

    </script>
</body>
</html>
